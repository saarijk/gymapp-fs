"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnsureRequestContext = void 0;
const MikroORM_1 = require("../MikroORM");
const RequestContext_1 = require("../utils/RequestContext");
function EnsureRequestContext(getContext) {
    return function (target, propertyKey, descriptor) {
        const originalMethod = descriptor.value;
        descriptor.value = async function (...args) {
            // reuse existing context if available
            if (RequestContext_1.RequestContext.currentRequestContext()) {
                return originalMethod.apply(this, args);
            }
            /* istanbul ignore next */
            const orm = getContext instanceof MikroORM_1.MikroORM ? getContext : (getContext?.(this) ?? this.orm);
            if (!(orm instanceof MikroORM_1.MikroORM)) {
                throw new Error('@EnsureRequestContext() decorator can only be applied to methods of classes with `orm: MikroORM` property, or with a callback parameter like `@EnsureRequestContext(() => orm)`');
            }
            return await RequestContext_1.RequestContext.create(orm.em, () => {
                return originalMethod.apply(this, args);
            });
        };
        return descriptor;
    };
}
exports.EnsureRequestContext = EnsureRequestContext;
